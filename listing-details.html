// location: netlify/functions/get-listings.js

exports.handler = async function(event, context) {
  const API_TOKEN = '7w14e1fzp5g5al7v9ky0dgx89'; 
  const { listingKey, page = 1, limit = 15, sort = 'RecentlyUpdated' } = event.queryStringParameters;

  // --- OData Sorting Options ---
  const sortOptions = {
    'RecentlyUpdated': 'ModificationTimestamp desc',
    'PriceLowHigh': 'ListPrice asc',
    'PriceHighLow': 'ListPrice desc'
  };
  const orderBy = sortOptions[sort] || sortOptions['RecentlyUpdated'];

  let apiUrl;

  if (listingKey) {
    // --- THIS IS THE CORRECTED LINE ---
    // Instead of using $filter, we are now accessing the resource directly by its key,
    // which is the format required by this API for single-item lookups.
    apiUrl = `https://replication.sparkapi.com/Version/3/Reso/OData/Property('${listingKey}')?$expand=Media,Rooms`;
  } else {
    // This logic for fetching all listings remains the same.
    const skip = (parseInt(page) - 1) * parseInt(limit);
    apiUrl = 'https://replication.sparkapi.com/Version/3/Reso/OData/Property?' +
               `$filter=MlsStatus eq 'Active'` +
               `&$expand=Media` +
               `&$orderby=${orderBy}` +
               `&$top=${limit}` +
               `&$skip=${skip}` +
               `&$count=true`;
  }

  try {
    const response = await fetch(apiUrl, {
      headers: {
        'Authorization': `Bearer ${API_TOKEN}`,
        'Accept': 'application/json'
      }
    });

    if (!response.ok) {
      const errorData = await response.text(); // Get more details on the error
      console.error("API Error Response:", errorData);
      return { statusCode: response.status, body: JSON.stringify({ error: `API Error: ${response.statusText}` }) };
    }

    const data = await response.json();
    return { statusCode: 200, body: JSON.stringify(data) };

  } catch (error) {
    console.error('Proxy server error:', error);
    return { statusCode: 500, body: JSON.stringify({ error: 'Proxy server error: ' + error.message }) };
  }
};
