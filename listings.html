<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Properties - Garrett Schaede | Grand Lake Luxury Properties</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #0d285e; --secondary-color: #a87d3e; --accent-color: #e0b66e;
      --text-dark: #2c3e50; --text-light: #ecf0f1;
      --background-light: #fdfaf6; --background-dark: #1a2c4a;
      --gradient-blue: linear-gradient(135deg, #0d285e 0%, #1a3a6b 100%);
      --shadow-medium: 0 10px 30px rgba(0,0,0,0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Montserrat', sans-serif; line-height: 1.7; color: var(--text-dark); background: var(--background-light); overflow-x: hidden; padding-top: 100px; }

    .header { background: var(--gradient-blue); color: var(--text-light); padding: 1rem 0; position: fixed; width: 100%; top: 0; z-index: 1000; box-shadow: var(--shadow-medium); transition: all 0.3s ease; }
    .header.scrolled { padding: 0.75rem 0; background: rgba(13,40,94,0.95); }

    .nav-container { max-width: 1300px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 2.5rem; }
    .logo { display: flex; align-items: center; gap: 0.8rem; text-decoration: none; color: var(--text-light); }
    .logo-image-file { width: 70px; height: 70px; object-fit: contain; border-radius: 50%; background: #fff; padding: 5px; border: 2px solid var(--accent-color); }
    .logo-text { display: flex; flex-direction: column; }
    .logo-title { font-family: 'Playfair Display', serif; font-size: 1.9rem; font-weight: 700; letter-spacing: 1.5px; line-height: 1; }
    .logo-subtitle { font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase; }
    .logo-tagline { font-size: 0.65rem; opacity: 0.7; margin-top: 0.2rem; font-style: italic; }

    .nav-links { display: flex; gap: 2.5rem; list-style: none; }
    .nav-links a { color: var(--text-light); text-decoration: none; font-weight: 500; font-size: 1.05rem; }

    .mobile-menu-btn { display: none; background: none; border: none; color: var(--text-light); font-size: 1.8rem; cursor: pointer; padding: 0.5rem; z-index: 1100; }
    .mobile-nav-overlay { display: none; position: fixed; inset: 0; background: rgba(13,40,94,0.98); z-index: 999; flex-direction: column; justify-content: center; align-items: center; }
    .mobile-nav-overlay.active { display: flex; }

    .page-header { text-align: center; padding: 6rem 0 3rem; color: var(--primary-color); }
    .page-header h1 { font-family: 'Playfair Display', serif; font-size: 3.5rem; margin-bottom: 0.5rem; }
    .page-header p { font-size: 1.2rem; color: var(--text-dark); opacity: 0.8; max-width: 800px; margin: 0 auto; }

    .section { padding: 4rem 0; }
    .container { max-width: 1300px; margin: 0 auto; padding: 0 2.5rem; }

    .listings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 2.5rem; margin-top: 2rem; }

    .property-card { background: #fff; border-radius: 8px; overflow: hidden; box-shadow: var(--shadow-medium); transition: transform .3s ease, box-shadow .3s ease; display: flex; flex-direction: column; height: 100%; }
    .property-card-link:hover .property-card { transform: translateY(-10px); box-shadow: 0 15px 40px rgba(0,0,0,.2); }
    .property-image { height: 250px; width: 100%; object-fit: cover; background: #eee; }
    .property-details { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; }
    .property-price { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem; }
    .property-address { font-size: 1.1rem; font-weight: 500; margin-bottom: 1rem; color: var(--text-dark); }
    .property-specs { display: flex; gap: 1.5rem; margin-top: auto; padding-top: 1rem; border-top: 1px solid #eee; color: #555; font-weight: 500; }
    .property-specs span { display: flex; align-items: center; gap: 0.5rem; }

    /* Make the whole card clickable without underlines */
    .property-card-link, .property-card-link * { text-decoration: none; color: inherit; }

    .search-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
    .total-found { font-size: 1.2rem; font-weight: 600; color: var(--text-dark); }
    .controls { display: flex; gap: 1rem; align-items: center; }
    .controls select, .controls label { font-size: 1rem; font-family: 'Montserrat', sans-serif; }
    .controls select { padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; background: #fff; }

    .pagination-container { display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 3rem; padding-bottom: 2rem; flex-wrap: wrap; }
    #pagination-container-top { margin-top: 0; margin-bottom: 2rem; padding-bottom: 0; }
    .pagination-container a, .pagination-container span { display: inline-block; padding: 0.6rem 1rem; border: 1px solid #ddd; background: #fff; color: var(--primary-color); text-decoration: none; border-radius: 4px; transition: background-color .2s, color .2s; cursor: pointer; }
    .pagination-container a:hover { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); }
    .pagination-container .current-page { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); cursor: default; }
    .pagination-container .disabled { color: #aaa; cursor: default; background-color: #f5f5f5; border-color: #eee; }
    .page-status { padding: 0.6rem 1rem; font-weight: 600; color: var(--primary-color); }

    .footer { background: var(--background-dark); color: var(--text-light); text-align: center; padding: 2.5rem 0; font-size: 0.9rem; border-top: 5px solid var(--primary-color); }
    .footer p { margin-bottom: 0.5rem; }
    .footer a { color: var(--accent-color); text-decoration: none; }

    @media (max-width: 768px) {
      .nav-links { display: none; }
      .mobile-menu-btn { display: block; }
      body { padding-top: 80px; }
      .search-header { flex-direction: column; align-items: flex-start; }
      .listings-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<header class="header" id="mainHeader">
  <div class="nav-container">
    <a href="index.html" class="logo" aria-label="Go to homepage">
      <img src="legacy%20logo.png" alt="Legacy Real Estate Logo" class="logo-image-file">
      <div class="logo-text">
        <div class="logo-title">Garrett Schaede</div>
        <div class="logo-subtitle">Real Estate</div>
        <div class="logo-tagline">INTEGRITY | INNOVATION | EXCELLENCE</div>
        <div class="logo-tagline">MLS 201633</div>
      </div>
    </a>
    <nav>
      <ul class="nav-links" aria-label="Main navigation">
        <li><a href="index.html">Home</a></li>
        <li><a href="index.html#about">About</a></li>
        <li><a href="listings.html" aria-current="page">Properties</a></li>
        <li><a href="index.html#services">Services</a></li>
        <li><a href="index.html#contact">Contact</a></li>
      </ul>
      <button class="mobile-menu-btn" onclick="toggleMobileNav()" aria-label="Open menu">
        <i class="fas fa-bars" aria-hidden="true"></i>
      </button>
    </nav>
  </div>
</header>

<div class="mobile-nav-overlay" id="mobileNav" aria-hidden="true">
  <button class="mobile-menu-btn" onclick="toggleMobileNav()" style="position:absolute;top:1.5rem;right:2rem" aria-label="Close menu">
    <i class="fas fa-times" aria-hidden="true"></i>
  </button>
  <ul class="nav-links" aria-label="Mobile navigation">
    <li><a href="index.html" onclick="toggleMobileNav()">Home</a></li>
    <li><a href="index.html#about" onclick="toggleMobileNav()">About</a></li>
    <li><a href="listings.html" onclick="toggleMobileNav()">Properties</a></li>
    <li><a href="index.html#services" onclick="toggleMobileNav()">Services</a></li>
    <li><a href="index.html#contact" onclick="toggleMobileNav()">Contact</a></li>
  </ul>
</div>

<div class="page-header">
  <div class="container">
    <h1>Local Listings</h1>
    <p>Explore our selection of featured properties on Grand Lake, Oklahoma.</p>
  </div>
</div>

<section id="listings-section" class="section" aria-label="Property listings">
  <div class="container" id="listings-container">

    <div class="search-header">
      <div class="total-found" id="total-found">Loading...</div>
      <div class="controls">
        <!-- Listings Per Page removed (fixed to 15) -->
        <label class="sr-only" for="sort-select">Sort listings</label>
        <select id="sort-select" aria-label="Sort listings">
          <option value="RecentlyUpdated" selected>Recently Updated</option>
          <option value="PriceLowHigh">Price: Low to High</option>
          <option value="PriceHighLow">Price: High to Low</option>
        </select>
      </div>
    </div>

    <!-- Top pagination -->
    <nav class="pagination-container" id="pagination-container-top" aria-label="Listings pagination (top)"></nav>

    <div class="listings-grid" id="listings-grid"></div>

    <!-- Bottom pagination -->
    <nav class="pagination-container" id="pagination-container-bottom" aria-label="Listings pagination (bottom)"></nav>

    <!-- Live region for page status (accessibility) -->
    <div id="pagination-status" class="sr-only" aria-live="polite"></div>

  </div>
</section>

<footer class="footer">
  <div class="container">
    <p>&copy; 2025 Legacy Real Estate. 117 Anchor Rd Grove, OK 74344. All rights reserved. | Garrett Schaede MLS 201633, Grand Lake Real Estate Specialist</p>
    <p>Serving Grand Lake o' the Cherokees and Grove, Oklahoma | Integrity | Innovation | Excellence</p>
    <p style="margin-top: 1rem; font-size: 0.8rem; opacity: 0.7;">
      Site Design by <a href="https://redeemeddigital.com" target="_blank" rel="noopener">Redeemed Digital</a>
    </p>
    <div class="social-links" style="margin-top: 1rem;">
      <a href="https://www.facebook.com/profile.php?id=100090638335625" target="_blank" rel="noopener" aria-label="Facebook Page">
        <i class="fab fa-facebook-square" style="font-size: 2rem; color: #a87d3e; transition: color 0.3s ease;"></i>
      </a>
    </div>
  </div>
</footer>

<script>
  // ---------- STATE ----------
  let currentPage = 1;
  const limit = 15;            // fixed page size
  let totalCount = 0;          // from API (@odata.count if provided)
  let currentSort = 'RecentlyUpdated';
  let lastPageItems = 0;       // for fallback when count is unknown

  const API = '/.netlify/functions/get-listings';

  function toggleMobileNav() {
    const el = document.getElementById('mobileNav');
    const isActive = el.classList.toggle('active');
    el.setAttribute('aria-hidden', String(!isActive));
  }

  window.addEventListener('scroll', () => {
    const header = document.getElementById('mainHeader');
    if (window.scrollY > 50) header.classList.add('scrolled'); else header.classList.remove('scrolled');
  });

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('sort-select').addEventListener('change', (e) => {
      currentSort = e.target.value;
      loadPage(1); // reset to first page on sort change
    });
    loadPage(1);
  });

  async function loadPage(page) {
    currentPage = page;

    const grid = document.getElementById('listings-grid');
    grid.innerHTML = '<p style="text-align:center; font-size:1.2rem; grid-column: 1 / -1;">Loading listings...</p>';

    try {
      const url = new URL(API, window.location.origin);
      url.searchParams.set('page', String(currentPage));
      url.searchParams.set('limit', String(limit));
      url.searchParams.set('sort', currentSort);

      const res = await fetch(url.toString());
      if (!res.ok) throw new Error('API request failed');

      const data = await res.json();
      const listings = Array.isArray(data.value) ? data.value : [];

      // Update counts and fallbacks
      if (typeof data['@odata.count'] === 'number') {
        totalCount = data['@odata.count'];
      }
      lastPageItems = listings.length;

      // Render
      displayListings(listings);

      // Build pagination
      setupPagination();

      // Update "Matches Found"
      const found = totalCount > 0 ? totalCount : (currentPage - 1) * limit + listings.length + ((listings.length === limit) ? '+' : '');
      document.getElementById('total-found').textContent = totalCount ? `${totalCount} Matches Found` : `${found} Matches Found`;

      document.getElementById('listings-section').scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
      console.error('Failed to fetch listings:', err);
      grid.innerHTML = `<p style="text-align:center; color:red; grid-column: 1 / -1;">Could not load property listings.</p>`;
      // Disable pagination on error
      document.getElementById('pagination-container-top').innerHTML = '';
      document.getElementById('pagination-container-bottom').innerHTML = '';
    }
  }

  // ----- RENDER LISTINGS (single page slice from server) -----
  function displayListings(listings) {
    const grid = document.getElementById('listings-grid');
    grid.innerHTML = '';

    if (!listings || listings.length === 0) {
      grid.innerHTML = `<p style="text-align:center; grid-column: 1 / -1;">No properties found on this page.</p>`;
      return;
    }

    listings.forEach(listing => {
      const imageUrl = (listing.Media && listing.Media.length > 0) ? listing.Media[0].MediaURL : 'https://via.placeholder.com/400x250.png?text=No+Image';
      const modifiedDate = listing.ModificationTimestamp
        ? new Date(listing.ModificationTimestamp).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
        : 'N/A';

      const living = listing.LivingArea != null ? Number(listing.LivingArea).toLocaleString() + ' sqft' : 'N/A';
      const address = listing.UnparsedAddress || 'Address unavailable';

      const card = `
        <a href="listing-details.html?listingKey=${encodeURIComponent(listing.ListingKey)}" class="property-card-link" aria-label="View details for ${address}">
          <div class="property-card">
            <img src="${imageUrl}" alt="Image of ${address}" class="property-image" loading="lazy">
            <div class="property-details">
              <div class="property-price">$${(listing.ListPrice || 0).toLocaleString()}</div>
              <div class="property-address">${address}</div>
              <div class="property-specs">
                <span><i class="fas fa-bed" aria-hidden="true"></i> ${listing.BedroomsTotal ?? 0}</span>
                <span><i class="fas fa-bath" aria-hidden="true"></i> ${listing.BathroomsTotalInteger ?? 0}</span>
                <span><i class="fas fa-ruler-combined" aria-hidden="true"></i> ${living}</span>
              </div>
            </div>
            <div class="property-card-footer">
              <div><strong>Listing Office:</strong> ${listing.ListOfficeName || 'N/A'}</div>
              <div><strong>Last Updated:</strong> ${modifiedDate}</div>
            </div>
          </div>
        </a>
      `;
      grid.insertAdjacentHTML('beforeend', card);
    });
  }

  // ----- PAGINATION (server-side) -----
  function setupPagination() {
    const top = document.getElementById('pagination-container-top');
    const bottom = document.getElementById('pagination-container-bottom');
    top.innerHTML = ''; bottom.innerHTML = '';

    const hasKnownTotal = Number.isFinite(totalCount) && totalCount > 0;
    const totalPages = hasKnownTotal ? Math.max(1, Math.ceil(totalCount / limit)) : null;

    // Determine if there's a next page when total is unknown (fallback)
    const hasNextWhenUnknown = !hasKnownTotal && (lastPageItems === limit);

    // If we neither know total nor have more pages, hide pagination
    if (!hasKnownTotal && currentPage === 1 && !hasNextWhenUnknown) {
      top.style.display = 'none';
      bottom.style.display = 'none';
      document.getElementById('pagination-status').textContent = `Showing page ${currentPage}.`;
      return;
    }
    top.style.display = 'flex';
    bottom.style.display = 'flex';

    const makeBtn = (page, label, disabled=false, current=false) => {
      const cls = [];
      if (current) cls.push('current-page');
      if (disabled) cls.push('disabled');
      if (disabled || current) {
        return `<span class="${cls.join(' ')}" data-page="${page}" ${current ? 'aria-current="page"' : ''}>${label}</span>`;
      }
      return `<a href="#page-${page}" class="${cls.join(' ')}" data-page="${page}" aria-label="Go to page ${page}">${label}</a>`;
    };

    let html = '';

    // Previous
    const prevDisabled = currentPage <= 1;
    html += makeBtn(currentPage - 1, 'Previous', prevDisabled);

    // Page numbers (only if we know total)
    if (hasKnownTotal) {
      const pages = [];
      if (totalPages <= 7) {
        for (let i = 1; i <= totalPages; i++) pages.push(i);
      } else {
        pages.push(1);
        if (currentPage > 3) pages.push('...');
        if (currentPage > 2) pages.push(currentPage - 1);
        if (currentPage > 1 && currentPage < totalPages) pages.push(currentPage);
        if (currentPage < totalPages - 1) pages.push(currentPage + 1);
        if (currentPage < totalPages - 2) pages.push('...');
        pages.push(totalPages);
      }

      pages.forEach(p => {
        if (p === '...') html += `<span class="disabled" aria-hidden="true">...</span>`;
        else html += makeBtn(p, String(p), false, p === currentPage);
      });
    } else {
      // Unknown total: show just "Page X"
      html += `<span class="page-status" aria-hidden="true">Page ${currentPage}</span>`;
    }

    // Next
    const nextDisabled = hasKnownTotal ? (currentPage >= totalPages) : !hasNextWhenUnknown;
    html += makeBtn(currentPage + 1, 'Next', nextDisabled);

    // Status
    const statusEl = document.getElementById('pagination-status');
    statusEl.textContent = hasKnownTotal ? `Showing page ${currentPage} of ${totalPages}.` : `Showing page ${currentPage}.`;

    top.innerHTML = html;
    bottom.innerHTML = html;

    const onClick = (e) => {
      const link = e.target.closest('a[data-page]');
      if (!link) return;
      e.preventDefault();
      const page = parseInt(link.dataset.page, 10);
      if (!Number.isNaN(page) && page !== currentPage) {
        loadPage(page);
      }
    };

    top.onclick = onClick;
    bottom.onclick = onClick;
  }
</script>
</body>
</html>
